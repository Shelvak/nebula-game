<?xml version="1.0" encoding="utf-8"?>
<base:Panel xmlns:fx="http://ns.adobe.com/mxml/2009" 
            xmlns:s="library://ns.adobe.com/flex/spark" 
            xmlns:mx="library://ns.adobe.com/flex/mx" 
            xmlns:base="components.base.*" 
            xmlns:unitsscreen="components.unitsscreen.*"
            title="{RM.getString('Units', 'label.flankNr'+flankModel.nr)}"
            skinClass="components.skins.FlankPanelSkin"
            creationComplete="panel1_creationCompleteHandler(event)" xmlns:unit="components.unit.*">
   
   <fx:Metadata>
      [ResourceBundle ("Units")]
   </fx:Metadata>
   
   <fx:Script>
      <![CDATA[
         import com.developmentarc.core.utils.EventBroker;
         
         import components.skins.ListNonScrollableSkin;
         import components.skins.ListScrollableSkin;
         import components.skins.ZoomInButtonSkin;
         import components.skins.ZoomOutButtonSkin;
         import components.unitsscreen.events.UnitsScreenEvent;
         
         import globalevents.GUnitsScreenEvent;
         
         import models.unit.Unit;
         import models.unit.UnitsFlank;
         
         import mx.collections.ArrayCollection;
         import mx.controls.Alert;
         import mx.core.IUIComponent;
         import mx.events.DragEvent;
         import mx.events.FlexEvent;
         import mx.graphics.SolidColor;
         import mx.managers.DragManager;
         
         import spark.components.List;
         import spark.events.IndexChangeEvent;
         import spark.primitives.Rect;
         
         [Bindable]
         public var flankModel: UnitsFlank;
         
         public function get selectedUnits(): Vector.<Object>
         {
            return unitsList.selectedItems;
         }
         
         protected function dragEnterHandler(event:DragEvent):void
         {           
            DragManager.acceptDragDrop(event.currentTarget as IUIComponent);
         }
         
         
         protected function unitsList_dragDropHandler(event:DragEvent):void
         {
            if (event.dragInitiator is List)
            { 
               var flanksObj: Object = {};
               for each (var unit: Unit in (event.dragInitiator as List).selectedItems)
               {
                  flanksObj[unit.id] = [flankModel.nr - 1, null];
               }
               new GUnitsScreenEvent(GUnitsScreenEvent.UNITS_UPDATED, flanksObj);
            }
            deselect = true;
         }
         
         private var deselect: Boolean = false;
         
         private function deselectAll(e: Event = null): void
         {
            unitsList.selectedIndices = new Vector.<int>;
            unitsList.addEventListener(FlexEvent.UPDATE_COMPLETE, unitsList_changeHandler);
         }
         
         private function selectAllUnits(e: Event = null): void
         {
            var allSelection: Vector.<int> = new Vector.<int>;
            for each (var unit: Unit in flankModel.flank)
            allSelection.push(flankModel.flank.getItemIndex(unit));
            unitsList.selectedIndices = allSelection;
            unitsList.addEventListener(FlexEvent.UPDATE_COMPLETE, unitsList_changeHandler);
         }
         
         private function updateStances(e: GUnitsScreenEvent): void
         {
            var flanksObj: Object = {};
            for each (var unit: Unit in unitsList.selectedItems)
            {
               flanksObj[unit.id] = [null, e.stance];
               unit.newStance = e.stance;
            }
            new GUnitsScreenEvent(GUnitsScreenEvent.UNITS_UPDATED, flanksObj);
            deselectAll();
         }
         
         protected function panel1_creationCompleteHandler(event:FlexEvent):void
         {
            addEventListener(UnitsScreenEvent.FLANK_SELECT_ALL, selectAllUnits);
            addEventListener(UnitsScreenEvent.FLANK_DESELECT, deselectAll);
            EventBroker.subscribe(GUnitsScreenEvent.DESELECT_UNITS, deselectAll);
            EventBroker.subscribe(GUnitsScreenEvent.SELECT_ALL, selectAllUnits);
            EventBroker.subscribe(GUnitsScreenEvent.SET_STANCE, updateStances);
         }
         
         
         protected function unitsList_changeHandler(event:Event = null):void
         {
            flankModel.selection = unitsList.selectedItems;
            new GUnitsScreenEvent(GUnitsScreenEvent.SELECTION_PRECHANGE);
            unitsList.removeEventListener(FlexEvent.UPDATE_COMPLETE, unitsList_changeHandler);
         }
         
      ]]>
   </fx:Script>
   <base:ScrollerVariableScrollStep id="scrollCont" top="0" bottom="0" left="0" right="0" horizontalScrollPolicy="off" 
                                    stepMultiplyer="5">
      <s:Group width="100%" height="100%">
         <base:AdvancedList id="unitsList" dataProvider="{flankModel.flank}" left="0" right="0" height="100%"
                            skinClass="components.skins.ListNonScrollableSkin"
                            useVirtualLayout="false" contentBackgroundColor="#0f0f0f"
                            rollOverColor="#4f4f4f" selectionColor="#2f2f2f" dragEnter="dragEnterHandler(event)"
                            borderVisible="false" dragMoveEnabled="true" change="unitsList_changeHandler(event)"
                            allowMultipleSelection="true" updateComplete="
                            if (deselect)
                            {
                            deselect = false;
                            deselectAll();
                            }"
                            dragEnabled="true" dropEnabled="true" dragDrop="unitsList_dragDropHandler(event)">
            <base:itemRenderer>
               <fx:Component>
                  <s:ItemRenderer width="100%" height="100%">
                     <fx:Script>
                        <![CDATA[
                           import models.unit.Unit;
                        ]]>
                     </fx:Script>
                     <unitsscreen:UnitComp deployable="{(data as Unit).deploysTo != null}" 
                                           stance="{(data as Unit).newStance}" level="{(data as Unit).level}" 
                                           hp="{(data as Unit).hp}" type="{(data as Unit).type}"
                                           unitModel="{(data as Unit)}"/>
                  </s:ItemRenderer>
               </fx:Component>
            </base:itemRenderer>
            <base:layout>
               <s:TileLayout id="flankLayout" horizontalGap="1"
                             requestedColumnCount="{unitsList.width / (flankLayout.columnWidth+1)}"/>
            </base:layout>
         </base:AdvancedList>
      </s:Group>
   </base:ScrollerVariableScrollStep>
</base:Panel>
